# .titan/workflows/create-pr-ai.yaml
# This workflow overrides the default one from the github plugin.

name: "Create Pull Request with AI + Linter + Tests"
description: "AI-powered PR creation with linting and testing validation."

# Extend the base workflow from the github plugin
extends: "plugin:github/create-pr-ai"

# Use hooks to inject custom steps
hooks:
  before_commit:
    # Step 1: Run linter
    - id: ruff-lint
      name: "Run Ruff Linter"
      plugin: project
      step: ruff_linter
      on_error: continue  # Continue even if linting finds issues

    # Step 2: Offer AI help for linting (optional)
    - id: ai-help-lint
      name: "AI Help - Linting"
      plugin: core
      step: ai_code_assistant
      params:
        context_key: "step_output"
        prompt_template: "Help me fix these linting issues:\n\n{context}"
        ask_confirmation: true
        fail_on_decline: false  # Optional - can decline
      on_error: continue

    # Step 3: Run tests
    - id: run-tests
      name: "Run Tests"
      plugin: project
      step: test_runner
      on_error: continue  # Continue to AI step even if tests fail

    # Step 4: Offer AI help for tests (MANDATORY if tests fail)
    - id: ai-help-tests
      name: "AI Help - Tests"
      plugin: core
      step: ai_code_assistant
      params:
        context_key: "step_output"
        prompt_template: "Help me fix these failing tests:\n\n{context}"
        ask_confirmation: true
        fail_on_decline: true  # MUST accept help or workflow stops
      on_error: fail  # Stop workflow if tests fail and user declines help
